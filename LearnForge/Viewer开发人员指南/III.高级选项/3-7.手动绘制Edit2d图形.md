# 手动绘制Edit2d图形

在您的应用程序中加载Edit2D后，您可以开始向PDF文件和图纸添加图形。本教程演示了如何使用JavaScript绘制和更改图形，使您可以一窥构成Edit2D扩展的机制。您将需要Google Chrome浏览器才能完成本教程。

在本教程中，您将学习如何：

* 绘制多边形和折线
* 添加和删​​除图形样式
* 绘制贝塞尔曲线和椭圆弧
* 将您的Edit2D图形与SVG相互转换

这是有关Edit 2D的四个教程之一。到目前为止，您应该已经完成​​了Set Edit2D的设置。本教程的末尾链接了其余的使用和自定义Edit2D教程。

## Step 1: 运行 Edit2D Playground

对于本教程，您需要设置Edit2D Playground。Edit2D Playground对于调试Edit2D和测试其功能很有用。要设置Playground，请将以下代码段复制到您的Chrome DevTools代码段集合中并运行它：

```js
// 方便访问扩展和层
window.edit2d = NOP_VIEWER.getExtension('Autodesk.Edit2D');
window.layer  = edit2d.defaultContext.layer;
window.tools  = edit2d.defaultTools;

// 方便的功能，用于每个控制台的工具切换。例如,startTool（tools.polygonTool）
var startTool = function(tool) {

  var controller = NOP_VIEWER.toolController;

  // 检查当前活动的工具是否来自Edit2D
  var activeTool = controller.getActiveTool();
  var isEdit2D = activeTool && activeTool.getName().startsWith("Edit2");

  // 停用任何先前的edit2d工具
  if (isEdit2D) {
      controller.deactivateTool(activeTool.getName());
      activeTool = null;
  }

  // 停止编辑工具
  if (!tool) {
      return;
  }

  controller.activateTool(tool.getName());
}
```

设置Edit2D Playground可使您快速访问某些Edit2D功能。请注意，由于这些功能是用于测试的机制，因此不应将其用于生产代码或环境。在本教程中，我们已使用它们来向您展示Edit2D扩展一旦在您的应用程序中加载后如何工作。

## Step 2: 检查图纸坐标

在以下步骤中，我们提供了代码片段，可让您绘制图形，直线和圆弧。但是，您将需要更改这些代码段中的坐标，以使这些项目在图纸的可见范围内。默认情况下，Edit2D使用与基础图纸相同的坐标系。要找出图纸的可见区域，可以选中模型的边界框：

```js
var box = NOP_Viewer.model.getBoundingBox();
```

您现在可以使用**box.min**和**box.max**检查x/y值。

## Step 3: 绘制多边形和折线

首先绘制一个多边形。输入以下代码段，将三角形添加到工作表中。请记住要调整坐标，以使三角形在PDF或图纸上可见。

```js
// 创建简单的三角形
var poly = new Autodesk.Edit2D.Polygon([
    {x: 53, y: 24},
    {x: 62, y: 24},
    {x: 57, y: 34}
]);

// 展示下
layer.addShape(poly);
```

您也可以使用类似的代码创建折线：

```js
//创建折线
var polyline = new Autodesk.Edit2D.Polyline([
    {x: 54, y: 30},
    {x: 54, y: 35},
    {x: 62, y: 35},
    {x: 62, y: 30}
]);

// Show it
layer.addShape(polyline);
```

## Step 4: 添加图形样式

所有Edit2D图形均具有配置其外观的**样式(style)**。让我们修改我们创建的多边形的样式。

```js
// 配置图形样式
var style = poly.style;
style.fillColor = 'rgb(255,0,0)';
style.fillAlpha = 0.3;
style.lineWidth = 1.0;
style.lineStyle = 11;

// show changes
layer.update();
```

注意，您必须使用layer.update()显示更改。这是因为编辑层知道它显示的图形，但是图形不知道哪个编辑层正在使用它。如果已经显示了要修改的图形(如本例所示)，则必须更新图层。

## Step 5: 撤销更改

<font color=gray size=4>5.1 移除图形</font>

要清除图形，可以使用**layer.removeShape(poly)**删除单个图形，也可以使用**layer.clear()**清除整个图层。

<font color=gray size=4>5.2 使用Undo(撤销)/Redo(重做)</font>

为简单起见，我们在示例中直接操作了该层。如果您在应用程序中使用Edit2D工具，则它们会跟踪撤消/重做历史。将此与手动修改混合会导致撤消历史记录与实际层状态之间的不一致。

为确保在撤消/重做历史记录中跟踪您的手动更改，您可以将所做的修改包装到操作中。

如果您使用的是Edit2D的默认工具栏，则**Edit2DContext**提供了用于跟踪您的手动更改的快捷方式。

```js
edit2d.defaultContext.clearLayer();
edit2d.defaultContext.addShape(poly);
edit2d.defaultContext.removeShape(poly);
```

通常，您可以通过在undoStack上调用run来执行操作。这是以这种方式添加多个图形的示例：

```js
const action = new Actions.AddShapes(this.layer, shapes);
this.undoStack.run(action);
```

## Step 6: 绘制Bezier Arcs(贝赛尔曲线)

多边形和折线只能包含直线段。若要创建完全或部分平滑的图形，可以使用路径图形。路径图形使您可以将直线段更改为贝塞尔弧线。

此示例演示如何创建多路径：

```js
// 创建简单的PolygonPath
var path = new Autodesk.Edit2D.PolygonPath([
    {x: 53, y: 24}, // a
    {x: 62, y: 24}, // b
    {x: 57, y: 34}  // c
]);

// 将线段(a,b)从直线更改为弧线
path.setBezierArc(
    0,              // 段索引(=其起始顶点的索引)
    54.72, 20.54,   // 定义起始切线的控制点
    60.53, 20.34    // 定义终点切线的控制点
);

// Show it
layer.addShape(path);
```

弧段由4个控制点P0，P1，P2，P3指定；

* P0和P3定义起点和终点。这些点是通过边线顶点的开始和结束位置预先指定的。
* P1和P2是控制弧的开始和结束切线的附加点。

如前所述，您需要**layer.update()**用于已经可见的图形，以显示调用**setBezierArc(..)**的更改。

创建折线路径类似于调用多边形路径。

```js
// 创建简单的PolylinePath
var path = new Autodesk.Edit2D.PolylinePath([
    {x: 53, y: 24}, // a
    {x: 62, y: 24}, // b
    {x: 57, y: 34}, // c
    {x: 53, y: 24}, // d = a (repeated to close the triangle)
]);

// 将线段(a,b)从直线更改为弧线
path.setBezierArc(0, 54.72, 20.54, 60.53, 20.34);

// Show it
layer.addShape(path);
```

请注意，当折线路径仅需要3时，折线路径需要4个顶点。这是因为使用多边形路径时，会自动添加从c到a的闭合线段。为了使用折线路径创建相同的闭合图形，您需要在终点处重复顶点a。通常，请注意，多边形的有效线段索引数是折线的**vertexCount-1**和**vertexCount-2**。

## Step 7: 绘制椭圆弧

下面的示例显示如何指定椭圆弧。所有椭圆参数与SVG标准中的1：1匹配。

```js
// 创建简单的PolygonPath
var path = new Autodesk.Edit2D.PolygonPath([
    {x: 53, y: 24}, // a
    {x: 62, y: 24}, // b
    {x: 57, y: 34}  // c
]);

// 将段0更改为椭圆弧
var params = new Autodesk.Edit2D.EllipseArcParams();

// 沿椭圆x/y轴的椭圆半径
params.rx = 4;
params.ry = 6;

// x/y轴的cw旋转度数。
// 旋转 0 表示 椭圆x轴 = (1,0)
params.rotation = 0;

// 是否在椭圆上使用较短或较长的路径。
params.largeArcFlag = false;

// 从startAngle逆时针(true)还是顺时针(false)。
params.sweepFlag = true;

path.setEllipseArc(0, params);

layer.addShape(path);
```

## Step 8: 将Edit2D图形与SVG图形相互转换

可将Edit2D图形与SVG图形相互转换。

<font color=gray size=4>8.1 导入SVG图形</font>

下面的示例演示如何导入单个SVG图形并将其转换为Edit2D图形。

```js
// 从SVG字符串创建Edit 2D图形
const svgString = '<path d="M 12.79,21.51 H 18.70 V 18.56 H 12.79 Z"/>';
const shape2    = Autodesk.Edit2D.Shape.fromSVG(svgString);
```

您也可以将Edit2D图形导出为SVG图形。

```js
// 从图形获取SVG字符串表示形式
shape.toSVG();
```

在以下示例中，我们将Edit2D图层的全部内容转换为SVG，并在弹出窗口中显示结果，

```js
function showSvgPopup() {

  // 窗口大小
  const width = 400;
  const height = 400;

  // 将pixel-scope定义为box2
  const pixelBox = new THREE.Box2();
  pixelBox.min.set(0, 0);
  pixelBox.max.set(width, height);

  // 将图层转换为svg元素
  const svg = Autodesk.Edit2D.Svg.createSvgElement(
      layer.shapes,
      { dstBox: pixelBox } // 重新缩放以适合pixelBox[0,400]^2
  );

  // 在弹出窗口中显示
  const w = window.open('', '', `width=${width},height=${height}`);
  w.document.body.appendChild(svg);
  w.document.close();
  };

  showSvgPopup();
```

从Edit2D导出时，可以选择添加样式属性。

```js
shape.toSVG({exportStyle: true});
```

**示例输出**：\<path d =” M 12.79,21.51 H 18.7 V 18.56 H 12.79 Z” stroke =” rgb（0,0,128）” fill =” rgb（0,0,128）” stroke-width =“ 3” fill-opacity =“ 0.2” />

您还可以将Edit2D的图层内容1：1序列化为xml文件并下载。

```js
function download(filename, text) {
  var element = document.createElement('a');
  element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  element.setAttribute('download', filename);

  element.style.display = 'none';
  document.body.appendChild(element);

  element.click();

  document.body.removeChild(element);
}

function downloadLayerAsSvg() {

  // 将pixel-scope定义为box2
  var pixelBox = new THREE.Box2();
  pixelBox.min.set(0, 0);
  pixelBox.max.set(400, 400);

  // 获取图层内容作为svg dom元素
  var svgElem = Autodesk.Edit2D.Svg.createSvgElement(layer.shapes, {dstBox: pixelBox});

  // 序列化为字符串并下载
  var serializer = new XMLSerializer();
  var xmlText = serializer.serializeToString(svg);

  download('test.svg', xmlText);
};
```
