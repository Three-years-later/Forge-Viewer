# 创建扩展

## 什么是扩展

扩展是JavaScript代码，用于扩展或修改Viewer的行为。当某些扩展程序与Viewer捆绑在一起时，您可以创建自己的扩展程序。

最好用一个例子来解释扩展的创建。下面显示的示例用来创建一个名为MyAwesomeExtension的Viewer扩展。

将有两个与添加的扩展交互的HTML按钮。它们将放置在“Viewer”画布的下方和外部。

其中一个按钮将用于锁定相机。 锁定后，您将无法绕轨道（旋转），平移或缩放。 下一个按钮将用于解锁相机，重新启用鼠标和触摸交互。

## Step 1: 引入扩展文件

在定义了Viewer的所有核心类之后，必须定义扩展。 本示例使用名为my-awesome-extension.js的文件，下面的代码片段显示了如何将其包括在HTML中。

```js
<script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
<script src="my-awesome-extension.js"></script>
```

## Step 2: 编辑扩展代码

扩展包含以下几个接口点：

* 继承自**Autodesk.Viewing.Extension**。
* 定义返回一个布尔值的方法**load()**。
* 定义方法**unload()**，该方法还返回一个布尔值。
* 用唯一的字符串ID注册自己。

```js
// “ my-awesome-extension.js”的内容

function MyAwesomeExtension(viewer, options) {
Autodesk.Viewing.Extension.call(this, viewer, options);
}

MyAwesomeExtension.prototype = Object.create(Autodesk.Viewing.Extension.prototype);
MyAwesomeExtension.prototype.constructor = MyAwesomeExtension;

MyAwesomeExtension.prototype.load = function() {
alert('MyAwesomeExtension is loaded!');
return true;
};

MyAwesomeExtension.prototype.unload = function() {
alert('MyAwesomeExtension is now unloaded!');
return true;
};

Autodesk.Viewing.theExtensionManager.registerExtension('MyAwesomeExtension', MyAwesomeExtension);
```

仅当**load()**返回true时，扩展程序才能成功加载到Viewer的生命周期中。 同样，如果**unload()**返回true，则扩展将成功卸载。

请注意，**registerExtension()**中使用的字符串'**MyAwesomeExtension**'不需要与函数名称声明匹配。

>注意：刷新HTML页面时不会加载扩展。

## Step 3: 加载扩展功能

指示Viewer实例加载扩展：

```js
var config3d = {
  ...
  extensions: ['MyAwesomeExtension'],
  ...
};
var htmlDiv = document.getElementById('forgeViewer')
viewer = new Autodesk.Viewing.GuiViewer3D(htmlDiv, config3d);
viewer.start();
...
viewer.loadModel(...);
```

刷新HTML页面会显示在扩展程序的**load()**方法中找到的**alert()**消息。

## Step 4: 添加HTML按钮

在查看器div后面添加两个简单的HTML按钮：

```html
<div id="forgeViewer"></div>
<button id="MyAwesomeLockButton">Lock it!</button>
<button id="MyAwesomeUnlockButton">Unlock it!</button>
```

## Step 5: 添加按钮处理程序

为了增强扩展程序的**load()**方法来处理HTML按钮的单击事件：请注意，我们的扩展程序具有**this.viewer**属性，这是Viewer大部分功能和自定义设置的主要访问点。

```js
MyAwesomeExtension.prototype.load = function() {
  // alert('MyAwesomeExtension is loaded!');

  var viewer = this.viewer;

  var lockBtn = document.getElementById('MyAwesomeLockButton');
  lockBtn.addEventListener('click', function() {
    viewer.setNavigationLock(true);
  });

  var unlockBtn = document.getElementById('MyAwesomeUnlockButton');
  unlockBtn.addEventListener('click', function() {
    viewer.setNavigationLock(false);
  });

  return true;
};
```

注意：扩展属性**this.viewer**是Viewer大部分功能和自定义设置的主要访问点。

重新加载HTML并使用鼠标来移动相机。 然后单击**Lock it!**并注意如何无法再用鼠标修改摄像机。您会注意到一些UI按钮也被隐藏了。

现在单击**Unlock it!**按钮再次启用相机互动。

## Step 6: 卸载时清理

卸载扩展程序时，最好删除添加到DOM元素的事件监听器。

要在unload方法中执行所有清理操作：

```js
function MyAwesomeExtension(viewer, options) {
  Autodesk.Viewing.Extension.call(this, viewer, options);

  // Preserve "this" reference when methods are invoked by event handlers. 当事件处理程序调用方法时，保留“ this”引用。
  this.lockViewport = this.lockViewport.bind(this);
  this.unlockViewport = this.unlockViewport.bind(this);
}

MyAwesomeExtension.prototype = Object.create(Autodesk.Viewing.Extension.prototype);
MyAwesomeExtension.prototype.constructor = MyAwesomeExtension;

MyAwesomeExtension.prototype.lockViewport = function() {
  this.viewer.setNavigationLock(true);
};

MyAwesomeExtension.prototype.unlockViewport = function() {
  this.viewer.setNavigationLock(false);
};

MyAwesomeExtension.prototype.load = function() {
  // alert('MyAwesomeExtension is loaded!');

  this._lockBtn = document.getElementById('MyAwesomeLockButton');
  this._lockBtn.addEventListener('click', this.lockViewport);

  this._unlockBtn = document.getElementById('MyAwesomeUnlockButton');
  this._unlockBtn.addEventListener('click', this.unlockViewport);

  return true;
};

 MyAwesomeExtension.prototype.unload = function() {
  // alert('MyAwesomeExtension is now unloaded!');

  if (this._lockBtn) {
    this._lockBtn.removeEventListener('click', this.lockViewport);
    this._lockBtn = null;
  }

  if (this._unlockBtn) {
      this._unlockBtn.removeEventListener('click', this.unlockViewport);
      this._unlockBtn = null;
  }

  return true;
};
```

## Step 7: 测试扩展

要完全测试该扩展程序是否按预期工作，可以手动强制加载和卸载该扩展程序。

在浏览器的控制台中，键入以下内容以检查扩展程序是否已加载。 此时，应加载扩展，函数调用应返回**true**：

```js
NOP_VIEWER.isExtensionLoaded('MyAwesomeExtension');
```

请注意使用全局变量NOP_VIEWER，该变量由开发人员在创建Viewer实例后由Viewer SDK定义。

现在键入以下内容以卸载(unload)扩展程序：

```js
NOP_VIEWER.unloadExtension('MyAwesomeExtension');
```

如果一切正常，添加的按钮将不再起作用。 单击它们进行验证。

然后，您可以通过调用再次加载扩展程序

```js
NOP_VIEWER.loadExtension('MyAwesomeExtension');
```

现在，添加的按钮将再次按预期工作。
